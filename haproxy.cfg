global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    retries 3

# HAProxy statistics page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# gRPC frontend (port 9090)
frontend monofs_grpc
    bind *:9090
    mode tcp
    default_backend monofs_routers_grpc

# HTTP API frontend (port 8080)
frontend monofs_http
    bind *:8080
    mode http
    default_backend monofs_routers_http

# gRPC backend - primary/backup failover (all traffic to router1 unless down)
backend monofs_routers_grpc
    mode tcp
    balance roundrobin
    option tcp-check
    
    server router1 router1:9090 check inter 5s fall 3 rise 2
    server router2 router2:9090 check inter 5s fall 3 rise 2 backup

# HTTP backend - primary/backup failover (all traffic to router1 unless down)
backend monofs_routers_http
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # Enable cookie-based session stickiness
    cookie MONOFS_ROUTER insert indirect nocache httponly
    
    server router1 router1:8080 check inter 5s fall 3 rise 2 cookie router1
    server router2 router2:8080 check inter 5s fall 3 rise 2 cookie router2 backup
